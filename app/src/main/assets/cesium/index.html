<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LocationMobile</title>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #cesiumContainer { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .control-panel { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; max-width: 90%; }
        .btn { padding: 12px 24px; font-size: 16px; font-weight: bold; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 25px; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; touch-action: manipulation; }
        .btn:active { transform: scale(0.95); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .info-box { position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.7); color: white; padding: 15px 20px; border-radius: 8px; font-size: 14px; max-width: 300px; z-index: 1000; display: none; }
        .info-box.show { display: block; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 18px; z-index: 999; background: rgba(0, 0, 0, 0.7); padding: 20px 40px; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="loading" id="loading">LocationMobile åŠ è½½ä¸­...</div>
    <div id="cesiumContainer"></div>
    <div class="info-box" id="infoBox"></div>
    <div class="control-panel">
        <button class="btn" onclick="requestLocation()">ğŸ“ è·å–ä½ç½®</button>
        <button class="btn" id="trackBtn" onclick="toggleTracking()">ğŸ¯ å¼€å§‹è·Ÿè¸ª</button>
        <button class="btn" onclick="clearMarkers()">ğŸ—‘ï¸ æ¸…é™¤æ ‡è®°</button>
    </div>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Cesium.js"></script>
    <script>
        Cesium.Ion.defaultAccessToken = 'YOUR_CESIUM_ION_ACCESS_TOKEN';
        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain(),
            timeline: false,
            animation: false,
            baseLayerPicker: true,
            fullscreenButton: false,
            vrButton: false,
            geocoder: false,
            homeButton: true,
            infoBox: true,
            sceneModePicker: true,
            selectionIndicator: true,
            navigationHelpButton: false,
            navigationInstructionsInitiallyVisible: false
        });
        viewer.cesiumWidget.creditContainer.style.display = "none";
        let locationMarker = null;
        let locationHistory = [];
        let trackLine = null;
        let isTracking = false;
        viewer.scene.globe.tileLoadProgressEvent.addEventListener(function(queuedTileCount) {
            if (queuedTileCount === 0) {
                document.getElementById('loading').style.display = 'none';
                logToAndroid('LocationMobileåœ°å›¾åŠ è½½å®Œæˆ');
            }
        });
        function requestLocation() {
            showInfo('æ­£åœ¨è·å–ä½ç½®...');
            if (typeof Android !== 'undefined' && Android.getLocation) {
                Android.getLocation();
            } else {
                showInfo('è¯·åœ¨LocationMobileåº”ç”¨ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½', 3000);
                console.error('Androidæ¥å£ä¸å¯ç”¨');
            }
        }
        function toggleTracking() {
            const trackBtn = document.getElementById('trackBtn');
            if (!isTracking) {
                if (typeof Android !== 'undefined' && Android.startTracking) {
                    Android.startTracking();
                    isTracking = true;
                    trackBtn.textContent = 'â¸ï¸ åœæ­¢è·Ÿè¸ª';
                    trackBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                    showInfo('å¼€å§‹ä½ç½®è·Ÿè¸ª', 2000);
                }
            } else {
                if (typeof Android !== 'undefined' && Android.stopTracking) {
                    Android.stopTracking();
                    isTracking = false;
                    trackBtn.textContent = 'ğŸ¯ å¼€å§‹è·Ÿè¸ª';
                    trackBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    showInfo('åœæ­¢ä½ç½®è·Ÿè¸ª', 2000);
                }
            }
        }
        function clearMarkers() {
            if (locationMarker) {
                viewer.entities.remove(locationMarker);
                locationMarker = null;
            }
            if (trackLine) {
                viewer.entities.remove(trackLine);
                trackLine = null;
            }
            locationHistory = [];
            showInfo('å·²æ¸…é™¤æ‰€æœ‰æ ‡è®°', 2000);
            logToAndroid('æ¸…é™¤æ‰€æœ‰æ ‡è®°');
        }
        function flyToLocation(longitude, latitude, altitude, accuracy = 0, updateType = 'single') {
            console.log(\`ä½ç½®æ›´æ–°: ç»åº¦=\${longitude}, çº¬åº¦=\${latitude}, æµ·æ‹”=\${altitude}, ç²¾åº¦=\${accuracy}, ç±»å‹=\${updateType}\`);
            const position = Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude);
            locationHistory.push(position);
            if (updateType === 'single' && locationMarker) {
                viewer.entities.remove(locationMarker);
            }
            const markerColor = updateType === 'single' ? Cesium.Color.RED : Cesium.Color.BLUE;
            const markerSize = updateType === 'single' ? 15 : 12;
            locationMarker = viewer.entities.add({
                name: 'å½“å‰ä½ç½®',
                position: position,
                point: {
                    pixelSize: markerSize,
                    color: markerColor,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 3
                },
                ellipse: accuracy > 0 ? {
                    semiMinorAxis: accuracy,
                    semiMajorAxis: accuracy,
                    material: Cesium.Color.BLUE.withAlpha(0.2),
                    outline: true,
                    outlineColor: Cesium.Color.BLUE.withAlpha(0.5),
                    outlineWidth: 2
                } : undefined,
                label: {
                    text: updateType === 'single' ? 'æˆ‘çš„ä½ç½®' : 'å½“å‰ä½ç½®',
                    font: '14pt sans-serif',
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    outlineWidth: 2,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -20)
                },
                description: \`
                    <div style="padding: 10px;">
                        <p><strong>ç»åº¦:</strong> \${longitude.toFixed(6)}</p>
                        <p><strong>çº¬åº¦:</strong> \${latitude.toFixed(6)}</p>
                        <p><strong>æµ·æ‹”:</strong> \${altitude.toFixed(2)} ç±³</p>
                        \${accuracy > 0 ? \`<p><strong>ç²¾åº¦:</strong> \${accuracy.toFixed(0)} ç±³</p>\` : ''}
                        <p><strong>æ—¶é—´:</strong> \${new Date().toLocaleString('zh-CN')}</p>
                    </div>
                \`
            });
            if (isTracking && locationHistory.length > 1) {
                updateTrackLine();
            }
            if (updateType === 'single') {
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude + 1000),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-45.0),
                        roll: 0.0
                    },
                    duration: 3
                });
            } else {
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(longitude, latitude, altitude + 500),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-30.0),
                        roll: 0.0
                    },
                    duration: 1.5
                });
            }
            const message = updateType === 'single' 
                ? \`å®šä½æˆåŠŸ!<br>ç»åº¦: \${longitude.toFixed(6)}<br>çº¬åº¦: \${latitude.toFixed(6)}\`
                : \`ä½ç½®å·²æ›´æ–°\`;
            if (updateType === 'single') {
                showInfo(message, 3000);
            }
        }
        function updateTrackLine() {
            if (trackLine) {
                viewer.entities.remove(trackLine);
            }
            trackLine = viewer.entities.add({
                name: 'ç§»åŠ¨è½¨è¿¹',
                polyline: {
                    positions: locationHistory,
                    width: 3,
                    material: new Cesium.PolylineGlowMaterialProperty({
                        glowPower: 0.2,
                        color: Cesium.Color.CYAN
                    })
                }
            });
        }
        function showInfo(message, duration = 0) {
            const infoBox = document.getElementById('infoBox');
            infoBox.innerHTML = message;
            infoBox.classList.add('show');
            if (duration > 0) {
                setTimeout(() => {
                    infoBox.classList.remove('show');
                }, duration);
            }
        }
        function hideInfo() {
            document.getElementById('infoBox').classList.remove('show');
        }
        function logToAndroid(message) {
            if (typeof Android !== 'undefined' && Android.log) {
                Android.log(message);
            }
            console.log(message);
        }
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(105.0, 35.0, 5000000.0),
            orientation: {
                heading: 0.0,
                pitch: Cesium.Math.toRadians(-90.0),
                roll: 0.0
            }
        });
        console.log('LocationMobileåœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        logToAndroid('LocationMobileåœ°å›¾åˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>
